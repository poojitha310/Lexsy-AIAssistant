<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Legal Assistant - Document & Email Analysis</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.2/marked.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #1a202c;
            line-height: 1.6;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #2d3748, #4a5568);
            color: white;
            padding: 1.25rem 0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.5rem;
            font-weight: 700;
            letter-spacing: -0.025em;
        }

        .logo i {
            font-size: 1.75rem;
            color: #81e6d9;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1rem;
            border: 2px solid rgba(255,255,255,0.2);
        }

        .logout-btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-1px);
        }

        .auth-section {
            background: white;
            border-radius: 16px;
            padding: 3rem;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            max-width: 450px;
            margin: 4rem auto;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .auth-header {
            text-align: center;
            margin-bottom: 2.5rem;
        }

        .auth-header h2 {
            font-size: 1.875rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 0.5rem;
        }

        .auth-header p {
            color: #718096;
            font-weight: 400;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            letter-spacing: 0.025em;
        }

        .form-input {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.2s;
            background: #f7fafc;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 380px 1fr;
            gap: 2rem;
            align-items: start;
        }

        .sidebar {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            position: sticky;
            top: 7rem;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .section {
            margin-bottom: 2.5rem;
        }

        .section:last-child {
            margin-bottom: 0;
        }

        .section h3 {
            font-size: 1.125rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: #2d3748;
            letter-spacing: -0.025em;
        }

        .btn {
            width: 100%;
            padding: 0.875rem 1.25rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
            font-size: 0.875rem;
            letter-spacing: 0.025em;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f7fafc;
            color: #4a5568;
            border: 2px solid #e2e8f0;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #edf2f7;
            border-color: #cbd5e0;
            transform: translateY(-1px);
        }

        .btn-danger {
            background: linear-gradient(135deg, #fc8181 0%, #e53e3e 100%);
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(229, 62, 62, 0.3);
        }

        .btn-gmail {
            background: linear-gradient(135deg, #4285f4 0%, #34a853 100%);
            color: white;
        }

        .btn-gmail:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(66, 133, 244, 0.3);
        }

        .upload-zone {
            border: 3px dashed #cbd5e0;
            border-radius: 12px;
            padding: 2.5rem 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #f7fafc;
            margin-bottom: 1rem;
        }

        .upload-zone:hover:not(.disabled) {
            border-color: #667eea;
            background: #edf2f7;
            transform: translateY(-2px);
        }

        .upload-zone.dragover {
            border-color: #667eea;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            transform: scale(1.02);
        }

        .upload-zone.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        .upload-icon {
            font-size: 3rem;
            color: #667eea;
            margin-bottom: 1rem;
        }

        .main-content {
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .tab-nav {
            display: flex;
            background: #f7fafc;
            border-bottom: 1px solid #e2e8f0;
        }

        .tab {
            flex: 1;
            padding: 1.25rem 1.5rem;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 600;
            color: #718096;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            position: relative;
        }

        .tab.active {
            background: white;
            color: #2d3748;
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .tab:hover:not(.active) {
            background: #edf2f7;
            color: #4a5568;
        }

        .tab-content {
            padding: 2.5rem;
            display: none;
            min-height: 600px;
        }

        .tab-content.active {
            display: block;
        }

        .chat-container {
            height: 600px;
            display: flex;
            flex-direction: column;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
            background: #f7fafc;
            border-radius: 12px;
            margin-bottom: 1.5rem;
            border: 1px solid #e2e8f0;
        }

        .message {
            margin-bottom: 2rem;
            display: flex;
            gap: 1rem;
            animation: fadeIn 0.4s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
            font-weight: 700;
            flex-shrink: 0;
        }

        .user .message-avatar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .assistant .message-avatar {
            background: linear-gradient(135deg, #2d3748 0%, #4a5568 100%);
            color: white;
        }

        .message-content {
            flex: 1;
            max-width: 85%;
        }

        .message-bubble {
            padding: 1.25rem 1.5rem;
            border-radius: 16px;
            word-wrap: break-word;
            line-height: 1.6;
            font-size: 0.95rem;
        }

        .user .message-bubble {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-bottom-right-radius: 6px;
        }

        .assistant .message-bubble {
            background: white;
            border: 2px solid #e2e8f0;
            border-bottom-left-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            color: #2d3748;
        }

        /* Markdown styling for AI responses */
        .assistant .message-bubble h1,
        .assistant .message-bubble h2,
        .assistant .message-bubble h3,
        .assistant .message-bubble h4 {
            color: #2d3748;
            font-weight: 700;
            margin: 1rem 0 0.5rem 0;
        }

        .assistant .message-bubble h1 { font-size: 1.25rem; }
        .assistant .message-bubble h2 { font-size: 1.125rem; }
        .assistant .message-bubble h3 { font-size: 1rem; }

        .assistant .message-bubble strong {
            color: #667eea;
            font-weight: 700;
        }

        .assistant .message-bubble ul,
        .assistant .message-bubble ol {
            margin: 0.75rem 0;
            padding-left: 1.5rem;
        }

        .assistant .message-bubble li {
            margin: 0.25rem 0;
        }

        .assistant .message-bubble p {
            margin: 0.75rem 0;
        }

        .assistant .message-bubble p:first-child {
            margin-top: 0;
        }

        .assistant .message-bubble p:last-child {
            margin-bottom: 0;
        }

        .message-sources {
            margin-top: 1rem;
            font-size: 0.8rem;
        }

        .source-tag {
            display: inline-block;
            background: rgba(102, 126, 234, 0.1);
            border: 1px solid rgba(102, 126, 234, 0.2);
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
            color: #667eea;
            font-weight: 500;
        }

        .chat-input-container {
            display: flex;
            gap: 1rem;
            align-items: flex-end;
        }

        .chat-input {
            flex: 1;
            padding: 1rem 1.25rem;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 0.95rem;
            resize: none;
            min-height: 50px;
            max-height: 150px;
            font-family: inherit;
            transition: all 0.2s;
        }

        .chat-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .send-btn {
            padding: 1rem 1.25rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            min-width: 100px;
        }

        .send-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .send-btn:disabled {
            background: #a0aec0;
            cursor: not-allowed;
            transform: none;
        }

        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
        }

        .empty-state i {
            font-size: 4rem;
            color: #cbd5e0;
            margin-bottom: 1.5rem;
        }

        .empty-state h3 {
            margin-bottom: 1rem;
            color: #4a5568;
            font-weight: 700;
        }

        .empty-state p {
            color: #718096;
            margin-bottom: 2rem;
            font-size: 1.05rem;
        }

        .content-list {
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
            max-height: 500px;
            overflow-y: auto;
        }

        .content-item {
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.2s;
            background: white;
        }

        .content-item:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.1);
            transform: translateY(-2px);
        }

        .content-title {
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.05rem;
        }

        .content-meta {
            font-size: 0.875rem;
            color: #718096;
            font-weight: 500;
        }

        .alert {
            padding: 1rem 1.25rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            animation: slideIn 0.3s ease;
            font-weight: 500;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .alert-success {
            background: #c6f6d5;
            color: #22543d;
            border: 1px solid #9ae6b4;
        }

        .alert-error {
            background: #fed7d7;
            color: #742a2a;
            border: 1px solid #fc8181;
        }

        .alert-info {
            background: #bee3f8;
            color: #2a4365;
            border: 1px solid #90cdf4;
        }

        .current-client {
            background: linear-gradient(135deg, #e6fffa 0%, #b2f5ea 100%);
            border: 2px solid #4fd1c7;
            border-radius: 12px;
            padding: 1.25rem;
            margin-top: 1rem;
            font-size: 0.875rem;
        }

        .client-actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .client-actions .btn {
            margin-bottom: 0;
            font-size: 0.8rem;
            padding: 0.6rem 1rem;
        }

        .suggestion-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .suggestion-btn {
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            color: #4a5568;
            padding: 0.75rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
            font-weight: 500;
        }

        .suggestion-btn:hover {
            background: #edf2f7;
            border-color: #667eea;
            color: #667eea;
            transform: translateY(-1px);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
            backdrop-filter: blur(4px);
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 2.5rem;
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.25);
        }

        .modal h3 {
            margin-bottom: 1.5rem;
            color: #2d3748;
            font-weight: 700;
            font-size: 1.5rem;
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: #718096;
            font-style: italic;
            font-weight: 500;
        }

        .typing-dots {
            display: flex;
            gap: 0.25rem;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #718096;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }

        @media (max-width: 768px) {
            .main-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .sidebar {
                position: static;
                order: 2;
            }

            .main-content {
                order: 1;
            }

            .container {
                padding: 1rem;
            }

            .chat-container {
                height: 500px;
            }

            .header-content {
                padding: 0 1rem;
            }

            .auth-section {
                margin: 2rem auto;
                padding: 2rem;
            }
        }

        /* Status indicators */
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-left: 0.5rem;
        }

        .status-ready { background: #48bb78; }
        .status-processing { background: #ed8936; }
        .status-failed { background: #f56565; }

        /* Loading states */
        .loading {
            opacity: 0.7;
            pointer-events: none;
        }

        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #e2e8f0;
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <i class="fas fa-scale-balanced"></i>
                <span>AI Legal Assistant</span>
            </div>
            <div class="user-info" id="userInfo" style="display: none;">
                <span id="userNameDisplay">User</span>
                <div class="user-avatar" id="userAvatar">U</div>
                <button onclick="logout()" class="logout-btn">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </div>
    </header>

    <!-- Authentication Section -->
    <div id="authSection" class="auth-section">
        <div class="auth-header">
            <h2>Welcome to AI Legal Assistant</h2>
            <p>Professional document and email analysis platform</p>
        </div>
        <form class="auth-form" onsubmit="handleAuth(event)">
            <div class="form-group">
                <label class="form-label">Full Name</label>
                <input type="text" class="form-input" id="userName" placeholder="Enter your full name" required>
            </div>
            <div class="form-group">
                <label class="form-label">Email Address</label>
                <input type="email" class="form-input" id="userEmail" placeholder="your@company.com" required>
            </div>
            <div class="form-group">
                <label class="form-label">Organization</label>
                <input type="text" class="form-input" id="userOrg" placeholder="Law firm or company name" required>
            </div>
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-sign-in-alt"></i>
                Access Platform
            </button>
        </form>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="container" style="display: none;">
        <div class="main-grid">
            <!-- Sidebar -->
            <aside class="sidebar">
                <!-- Client Management -->
                <div class="section">
                    <h3><i class="fas fa-users"></i> Client Management</h3>
                    
                    <div class="client-selector">
                        <select id="clientSelector" class="form-input" onchange="switchClient()">
                            <option value="">Select Client...</option>
                        </select>
                        
                        <div id="currentClient" class="current-client" style="display: none;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                <div style="flex: 1;">
                                    <strong id="currentClientName">Client Name</strong>
                                    <div style="font-size: 0.75rem; color: #4a5568; margin-top: 0.25rem;" id="currentClientStats">
                                        Loading stats...
                                    </div>
                                </div>
                                <div style="display: flex; gap: 0.5rem; align-items: center;">
                                    <span id="docsIndicator" title="Has Documents" style="display: none;">📄</span>
                                    <span id="emailsIndicator" title="Has Emails" style="display: none;">📧</span>
                                </div>
                            </div>
                            
                            <div class="client-actions">
                                <button class="btn btn-secondary" onclick="loadClientSampleData()" id="loadSampleBtn">
                                    <i class="fas fa-database"></i>
                                    Load Sample Data
                                </button>
                                <button class="btn btn-danger" onclick="deleteCurrentClient()" id="deleteClientBtn">
                                    <i class="fas fa-trash"></i>
                                    Delete Client
                                </button>
                            </div>
                        </div>
                        
                        <button class="btn btn-secondary" onclick="showAddClientModal()" style="margin-top: 1rem;">
                            <i class="fas fa-plus"></i>
                            Add New Client
                        </button>
                    </div>
                </div>

                <!-- Document Upload -->
                <div class="section">
                    <h3><i class="fas fa-cloud-upload-alt"></i> Upload Documents</h3>
                    <div class="upload-zone" id="uploadZone">
                        <div class="upload-icon">
                            <i class="fas fa-cloud-upload-alt"></i>
                        </div>
                        <div style="font-weight: 600; margin-bottom: 0.5rem; color: #4a5568;">Drop files here or click to browse</div>
                        <div style="font-size: 0.875rem; color: #718096;">PDF, DOCX, TXT • Max 10MB</div>
                        <div style="font-size: 0.75rem; margin-top: 0.75rem; font-weight: 600;" id="uploadNote">
                            Select a client first
                        </div>
                        <input type="file" id="fileInput" multiple accept=".pdf,.docx,.doc,.txt" style="display: none;">
                    </div>
                </div>

                <!-- Gmail Integration -->
                <div class="section">
                    <h3><i class="fab fa-google"></i> Gmail Integration</h3>
                    <button class="btn btn-gmail" onclick="connectGmail()" id="gmailBtn">
                        <i class="fab fa-google"></i>
                        Connect Gmail
                    </button>
                    <div id="gmailStatus" style="display: none; margin-top: 1rem; padding: 0.75rem; background: #c6f6d5; border: 1px solid #9ae6b4; border-radius: 8px; font-size: 0.875rem; color: #22543d; font-weight: 500;">
                        <i class="fas fa-check-circle"></i> Gmail Connected (Demo Mode)
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="section">
                    <h3><i class="fas fa-magic"></i> Quick Actions</h3>
                    <button class="btn btn-primary" onclick="initializeFullDemo()" id="demoSetupBtn">
                        <i class="fas fa-magic"></i>
                        Initialize Demo
                    </button>
                    <button class="btn btn-secondary" onclick="clearAllData()">
                        <i class="fas fa-trash-alt"></i>
                        Clear All Data
                    </button>
                </div>
            </aside>

            <!-- Main Content -->
            <main class="main-content">
                <nav class="tab-nav">
                    <button class="tab active" onclick="switchTab('chat')">
                        <i class="fas fa-comments"></i> Chat Analysis
                    </button>
                    <button class="tab" onclick="switchTab('documents')">
                        <i class="fas fa-file-alt"></i> Documents
                    </button>
                    <button class="tab" onclick="switchTab('emails')">
                        <i class="fas fa-envelope"></i> Email Threads
                    </button>
                </nav>

                <!-- Chat Tab -->
                <div id="chatTab" class="tab-content active">
                    <div class="chat-container">
                        <div class="chat-messages" id="chatMessages">
                            <div class="message assistant">
                                <div class="message-avatar">AI</div>
                                <div class="message-content">
                                    <div class="message-bubble">
                                        <p>👋 <strong>Welcome to AI Legal Assistant!</strong></p>
                                        <p>I'm here to help you analyze legal documents and email communications. To get started:</p>
                                        <ul>
                                            <li><strong>Select a client</strong> from the sidebar</li>
                                            <li><strong>Upload documents</strong> or <strong>connect Gmail</strong></li>
                                            <li><strong>Ask questions</strong> about legal matters</li>
                                        </ul>
                                        <p>Try the <strong>Initialize Demo</strong> button to load sample legal data and see the platform in action!</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Suggested Questions -->
                        <div id="suggestedQuestions" class="suggestion-buttons" style="display: none;">
                            <!-- Questions will be populated dynamically -->
                        </div>

                        <div class="chat-input-container">
                            <textarea id="chatInput" class="chat-input" placeholder="Select a client first, then ask about their legal matters..." rows="1" disabled></textarea>
                            <button class="send-btn" onclick="sendMessage()" id="sendBtn" disabled>
                                <i class="fas fa-paper-plane"></i>
                                Send
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Documents Tab -->
                <div id="documentsTab" class="tab-content">
                    <div id="documentsContent" class="empty-state">
                        <i class="fas fa-file-alt"></i>
                        <h3>No Documents Yet</h3>
                        <p>Select a client and upload PDF, DOCX, or TXT files to start analysis</p>
                        <button class="btn btn-primary" onclick="switchTab('chat')" style="max-width: 200px; margin: 0 auto;">
                            <i class="fas fa-arrow-left"></i>
                            Back to Chat
                        </button>
                    </div>
                </div>

                <!-- Email Threads Tab -->
                <div id="emailsTab" class="tab-content">
                    <div id="emailsContent" class="empty-state">
                        <i class="fas fa-envelope"></i>
                        <h3>No Email Threads</h3>
                        <p>Select a client and connect Gmail to analyze email communications</p>
                        <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                            <button class="btn btn-gmail" onclick="connectGmail()">
                                <i class="fab fa-google"></i>
                                Connect Gmail
                            </button>
                            <button class="btn btn-secondary" onclick="switchTab('chat')">
                                <i class="fas fa-arrow-left"></i>
                                Back to Chat
                            </button>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Add Client Modal -->
    <div id="addClientModal" class="modal">
        <div class="modal-content">
            <h3>Add New Client</h3>
            <form id="addClientForm" onsubmit="addNewClient(event)">
                <div class="form-group">
                    <label class="form-label">Client Name</label>
                    <input type="text" class="form-input" id="newClientName" placeholder="e.g., John Doe" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Email Address</label>
                    <input type="email" class="form-input" id="newClientEmail" placeholder="client@company.com" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Company/Organization</label>
                    <input type="text" class="form-input" id="newClientCompany" placeholder="Company Name LLC" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Description (Optional)</label>
                    <textarea class="form-input" id="newClientDescription" rows="3" placeholder="Brief description of legal matters..."></textarea>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">
                        <i class="fas fa-plus"></i>
                        Add Client
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="hideAddClientModal()" style="flex: 1;">
                        <i class="fas fa-times"></i>
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ===== GLOBAL VARIABLES AND INITIALIZATION =====
        let currentUser = null;
        let isAuthenticated = false;
        let currentClientId = null;
        let availableClients = [];
        const API_BASE = window.location.origin;

        // Markdown renderer configuration
        marked.setOptions({
            breaks: true,
            gfm: true,
            sanitize: false
        });

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            setupEventListeners();
        });

        function checkAuth() {
            const stored = localStorage.getItem('aiAssistantUser');
            if (stored) {
                currentUser = JSON.parse(stored);
                showMainApp();
            }
        }

        function handleAuth(event) {
            event.preventDefault();
            
            const name = document.getElementById('userName').value;
            const email = document.getElementById('userEmail').value;
            const org = document.getElementById('userOrg').value;
            
            currentUser = { name, email, org };
            localStorage.setItem('aiAssistantUser', JSON.stringify(currentUser));
            
            showMainApp();
        }

        function showMainApp() {
            document.getElementById('authSection').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            
            // Update header
            const userInfo = document.getElementById('userInfo');
            const userNameDisplay = document.getElementById('userNameDisplay');
            const userAvatar = document.getElementById('userAvatar');
            
            if (currentUser && currentUser.name && userNameDisplay && userAvatar) {
                userInfo.style.display = 'flex';
                userNameDisplay.textContent = currentUser.name;
                userAvatar.textContent = currentUser.name.charAt(0).toUpperCase();
            }
            
            isAuthenticated = true;
            loadClients();
            
            showAlert(`Welcome ${currentUser?.name || 'User'}! Ready to analyze legal documents.`, 'success');
        }

        function logout() {
            localStorage.removeItem('aiAssistantUser');
            currentUser = null;
            isAuthenticated = false;
            currentClientId = null;
            availableClients = [];
            
            document.getElementById('authSection').style.display = 'block';
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('userInfo').style.display = 'none';
            
            document.querySelector('.auth-form').reset();
            resetAppState();
        }

        function setupEventListeners() {
            // File upload
            const uploadZone = document.getElementById('uploadZone');
            const fileInput = document.getElementById('fileInput');

            if (uploadZone && fileInput) {
                uploadZone.addEventListener('click', () => {
                    if (currentClientId) {
                        fileInput.click();
                    }
                });
                uploadZone.addEventListener('dragover', handleDragOver);
                uploadZone.addEventListener('dragleave', handleDragLeave);
                uploadZone.addEventListener('drop', handleFileDrop);
                fileInput.addEventListener('change', handleFileSelect);
            }

            // Chat input
            const chatInput = document.getElementById('chatInput');
            if (chatInput) {
                chatInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });

                chatInput.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = Math.min(this.scrollHeight, 150) + 'px';
                });
            }

            // Close modal when clicking outside
            window.addEventListener('click', function(event) {
                const modal = document.getElementById('addClientModal');
                if (event.target === modal) {
                    hideAddClientModal();
                }
            });
        }

        // ===== CLIENT MANAGEMENT FUNCTIONS =====
        
        async function loadClients() {
            try {
                const response = await fetch(`${API_BASE}/api/clients`, {
                    headers: {
                        'X-User-Email': currentUser?.email || 'demo@example.com',
                        'X-User-Name': currentUser?.name || 'Demo User'
                    }
                });
                const data = await response.json();
                
                if (data.success && data.clients) {
                    availableClients = data.clients;
                    
                    const selector = document.getElementById('clientSelector');
                    if (selector) {
                        selector.innerHTML = '<option value="">Select Client...</option>';
                        
                        availableClients.forEach(client => {
                            const option = document.createElement('option');
                            option.value = client.id;
                            option.textContent = `${client.name} (${client.company})`;
                            selector.appendChild(option);
                        });
                        
                        // Auto-select Lexsy if available
                        const lexsyClient = availableClients.find(c => c.name.includes('Lexsy'));
                        if (lexsyClient) {
                            selector.value = lexsyClient.id;
                            await switchClient();
                        }
                    }
                }
                
            } catch (error) {
                console.error('Error loading clients:', error);
                showAlert('Failed to load clients', 'error');
            }
        }

        async function switchClient() {
            const selector = document.getElementById('clientSelector');
            if (!selector) return;
            
            const clientId = selector.value;
            
            if (!clientId) {
                currentClientId = null;
                const currentClientEl = document.getElementById('currentClient');
                if (currentClientEl) {
                    currentClientEl.style.display = 'none';
                }
                updateUploadZone();
                updateChatPlaceholder();
                clearChat();
                return;
            }
            
            try {
                currentClientId = parseInt(clientId);
                
                const response = await fetch(`${API_BASE}/api/clients/${clientId}`, {
                    headers: {
                        'X-User-Email': currentUser?.email || 'demo@example.com',
                        'X-User-Name': currentUser?.name || 'Demo User'
                    }
                });
                
                const data = await response.json();
                
                if (data.success && data.client) {
                    const client = data.client;
                    
                    const nameEl = document.getElementById('currentClientName');
                    const clientEl = document.getElementById('currentClient');
                    const statsEl = document.getElementById('currentClientStats');
                    
                    if (nameEl) nameEl.textContent = client.name;
                    if (clientEl) clientEl.style.display = 'block';
                    
                    const stats = client.stats || {};
                    if (statsEl) {
                        statsEl.textContent = `${stats.documents || 0} docs • ${stats.emails || 0} emails • ${stats.conversations || 0} chats`;
                    }
                    
                    const docsIndicator = document.getElementById('docsIndicator');
                    const emailsIndicator = document.getElementById('emailsIndicator');
                    if (docsIndicator) {
                        docsIndicator.style.display = (stats.documents > 0) ? 'inline' : 'none';
                    }
                    if (emailsIndicator) {
                        emailsIndicator.style.display = (stats.emails > 0) ? 'inline' : 'none';
                    }
                    
                    showAlert(`Switched to ${client.name}`, 'success');
                    
                    updateUploadZone();
                    updateChatPlaceholder();
                    loadSuggestedQuestions();
                    clearChat();
                    
                    // Add client switch message
                    addMessage('assistant', `🔄 **Switched to client: ${client.name}**\n\nYou can now ask questions about their documents and emails, or load sample data to get started.`);
                    
                } else {
                    showAlert('Failed to get client details', 'error');
                }
            } catch (error) {
                showAlert('Failed to switch client', 'error');
                console.error('Switch client error:', error);
            }
        }

        function clearChat() {
            const chatMessages = document.getElementById('chatMessages');
            if (chatMessages) {
                chatMessages.innerHTML = '';
            }
        }

        async function addNewClient(event) {
            event.preventDefault();
            
            const formData = new FormData();
            formData.append('name', document.getElementById('newClientName').value);
            formData.append('email', document.getElementById('newClientEmail').value);
            formData.append('company', document.getElementById('newClientCompany').value);
            formData.append('description', document.getElementById('newClientDescription').value);
            
            try {
                const response = await fetch(`${API_BASE}/api/clients`, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-User-Email': currentUser?.email || 'demo@example.com',
                        'X-User-Name': currentUser?.name || 'Demo User'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert(`Client ${data.client.name} added successfully!`, 'success');
                    hideAddClientModal();
                    await loadClients();
                    
                    const selector = document.getElementById('clientSelector');
                    if (selector) {
                        selector.value = data.client.id;
                        await switchClient();
                    }
                } else {
                    showAlert(`Failed to add client: ${data.error}`, 'error');
                }
            } catch (error) {
                showAlert('Error adding client', 'error');
                console.error('Add client error:', error);
            }
        }

        function showAddClientModal() {
            const modal = document.getElementById('addClientModal');
            if (modal) {
                modal.style.display = 'block';
            }
        }

        function hideAddClientModal() {
            const modal = document.getElementById('addClientModal');
            const form = document.getElementById('addClientForm');
            
            if (modal) modal.style.display = 'none';
            if (form) form.reset();
        }

        async function deleteCurrentClient() {
            if (!currentClientId) return;
            
            const client = availableClients.find(c => c.id === currentClientId);
            if (!client) return;
            
            if (confirm(`Are you sure you want to delete ${client.name}? This will remove all their documents, emails, and conversations.`)) {
                try {
                    const response = await fetch(`${API_BASE}/api/clients/${currentClientId}`, {
                        method: 'DELETE',
                        headers: {
                            'X-User-Email': currentUser?.email || 'demo@example.com',
                            'X-User-Name': currentUser?.name || 'Demo User'
                        }
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        showAlert(`${client.name} deleted successfully`, 'success');
                        
                        currentClientId = null;
                        const currentClientEl = document.getElementById('currentClient');
                        if (currentClientEl) {
                            currentClientEl.style.display = 'none';
                        }
                        
                        await loadClients();
                        updateUploadZone();
                        updateChatPlaceholder();
                        clearChat();
                        
                    } else {
                        showAlert(`Failed to delete client: ${data.error}`, 'error');
                    }
                } catch (error) {
                    showAlert('Error deleting client', 'error');
                    console.error('Delete client error:', error);
                }
            }
        }

        // ===== CHAT AND MESSAGING FUNCTIONS =====
        
        async function sendMessage() {
            if (!isAuthenticated || !currentClientId) {
                showAlert('Please select a client first', 'error');
                return;
            }

            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            addMessage('user', message);
            input.value = '';
            input.style.height = 'auto';
            
            const suggestionsEl = document.getElementById('suggestedQuestions');
            if (suggestionsEl) {
                suggestionsEl.style.display = 'none';
            }
            
            showTypingIndicator();
            
            const sendBtn = document.getElementById('sendBtn');
            const originalContent = sendBtn.innerHTML;
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<div class="spinner"></div>';
            
            try {
                const formData = new FormData();
                formData.append('question', message);
                formData.append('include_history', 'true');
                
                const response = await fetch(`${API_BASE}/api/chat/${currentClientId}/ask`, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-User-Email': currentUser?.email || 'demo@example.com',
                        'X-User-Name': currentUser?.name || 'Demo User'
                    }
                });
                
                const data = await response.json();
                
                hideTypingIndicator();
                
                if (data.success) {
                    addMessage('assistant', data.answer, data.sources);
                } else {
                    addMessage('assistant', '❌ Sorry, I encountered an error analyzing your request. Please try again.');
                }
            } catch (error) {
                hideTypingIndicator();
                addMessage('assistant', '❌ Connection error. Please check your internet connection and try again.');
                console.error('Chat error:', error);
            } finally {
                sendBtn.disabled = false;
                sendBtn.innerHTML = originalContent;
            }
        }

        function addMessage(sender, content, sources = null) {
            const messagesContainer = document.getElementById('chatMessages');
            if (!messagesContainer) return;
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            let sourcesHtml = '';
            if (sources && sources.length > 0) {
                sourcesHtml = '<div class="message-sources" style="margin-top: 1rem; font-size: 0.8rem;">';
                sourcesHtml += '<strong style="color: #4a5568;">Sources:</strong><br>';
                sources.forEach(source => {
                    const icon = source.type === 'document' ? 'fa-file-pdf' : 'fa-envelope';
                    const name = source.filename || source.subject || 'Source';
                    sourcesHtml += `<span class="source-tag"><i class="fas ${icon}"></i> ${name}</span>`;
                });
                sourcesHtml += '</div>';
            }
            
            const avatarText = sender === 'user' 
                ? (currentUser?.name?.charAt(0)?.toUpperCase() || 'U')
                : 'AI';
            
            // Process content based on sender
            let processedContent = content;
            if (sender === 'assistant') {
                // Use marked.js to render markdown
                processedContent = marked.parse(content);
            }
            
            messageDiv.innerHTML = `
                <div class="message-avatar">${avatarText}</div>
                <div class="message-content">
                    <div class="message-bubble">${processedContent}</div>
                    ${sourcesHtml}
                </div>
            `;
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function showTypingIndicator() {
            const messagesContainer = document.getElementById('chatMessages');
            if (!messagesContainer) return;
            
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message assistant';
            typingDiv.id = 'typingIndicator';
            
            typingDiv.innerHTML = `
                <div class="message-avatar">AI</div>
                <div class="message-content">
                    <div class="message-bubble">
                        <div class="typing-indicator">
                            <span>Analyzing documents...</span>
                            <div class="typing-dots">
                                <div class="typing-dot"></div>
                                <div class="typing-dot"></div>
                                <div class="typing-dot"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            messagesContainer.appendChild(typingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function hideTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            if (indicator) {
                indicator.remove();
            }
        }

        async function loadSuggestedQuestions() {
            if (!currentClientId) return;
            
            const suggestionsContainer = document.getElementById('suggestedQuestions');
            if (!suggestionsContainer) return;
            
            let suggestions = [];
            
            const client = availableClients.find(c => c.id === currentClientId);
            if (client && client.name.includes('Lexsy')) {
                suggestions = [
                    "What equity grant was proposed for John Smith?",
                    "What are the vesting terms discussed in emails?",
                    "How many shares are available in our equity incentive plan?",
                    "What documentation is needed for the advisor agreement?",
                    "What board approvals are required?"
                ];
            } else {
                suggestions = [
                    "Summarize the key legal documents",
                    "What compliance requirements do we have?",
                    "What decisions were made in recent emails?",
                    "What action items are pending?"
                ];
            }
            
            suggestionsContainer.innerHTML = '';
            suggestions.forEach(question => {
                const btn = document.createElement('button');
                btn.className = 'suggestion-btn';
                btn.textContent = question;
                btn.onclick = () => {
                    const chatInput = document.getElementById('chatInput');
                    if (chatInput) {
                        chatInput.value = question;
                        sendMessage();
                    }
                };
                suggestionsContainer.appendChild(btn);
            });
            
            suggestionsContainer.style.display = suggestions.length > 0 ? 'flex' : 'none';
        }

        // ===== FILE UPLOAD FUNCTIONS =====
        
        function handleDragOver(e) {
            e.preventDefault();
            if (currentClientId) {
                e.currentTarget.classList.add('dragover');
            }
        }

        function handleDragLeave(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
        }

        function handleFileDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
            
            if (!isAuthenticated) {
                showAlert('Please sign in first to upload files', 'error');
                return;
            }
            
            if (!currentClientId) {
                showAlert('Please select a client first to upload files', 'error');
                return;
            }
            
            const files = Array.from(e.dataTransfer.files);
            handleFiles(files);
        }

        function handleFileSelect(e) {
            if (!isAuthenticated || !currentClientId) {
                return;
            }
            
            const files = Array.from(e.target.files);
            handleFiles(files);
        }

        function handleFiles(files) {
            if (!currentClientId) {
                showAlert('Please select a client first to upload files', 'error');
                return;
            }

            const validTypes = ['application/pdf', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document', 'text/plain'];
            const maxSize = 10 * 1024 * 1024; // 10MB

            files.forEach(file => {
                if (!validTypes.includes(file.type)) {
                    showAlert(`Unsupported file type: ${file.name}. Use PDF, DOCX, or TXT.`, 'error');
                    return;
                }

                if (file.size > maxSize) {
                    showAlert(`File too large: ${file.name}. Max size is 10MB.`, 'error');
                    return;
                }

                uploadFile(file);
            });
        }

        async function uploadFile(file) {
            if (!currentClientId) {
                showAlert('Please select a client first', 'error');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            try {
                showAlert(`Uploading ${file.name}...`, 'info');

                const response = await fetch(`${API_BASE}/api/documents/${currentClientId}/upload`, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-User-Email': currentUser?.email || 'demo@example.com',
                        'X-User-Name': currentUser?.name || 'Demo User'
                    }
                });

                const result = await response.json();

                if (result.success) {
                    showAlert(`${file.name} uploaded and analyzed successfully!`, 'success');
                    
                    const documentsTab = document.getElementById('documentsTab');
                    if (documentsTab && documentsTab.classList.contains('active')) {
                        loadDocuments();
                    }
                    
                    await switchClient();

                    const clientName = availableClients.find(c => c.id === currentClientId)?.name || 'this client';
                    addMessage('assistant', `📄 **Document Processed Successfully!**\n\nI've analyzed "${file.name}" for ${clientName}. You can now ask questions about its contents!`);

                } else {
                    showAlert(`Upload failed: ${result.error}`, 'error');
                }
            } catch (error) {
                showAlert(`Upload error: ${error.message}`, 'error');
                console.error('Upload error:', error);
            }
        }

        async function loadClientSampleData() {
            if (!currentClientId) {
                showAlert('Please select a client first', 'error');
                return;
            }
            
            try {
                showAlert('Loading sample data for client...', 'info');
                
                const docResponse = await fetch(`${API_BASE}/api/documents/${currentClientId}/upload-sample-documents`, {
                    method: 'POST',
                    headers: {
                        'X-User-Email': currentUser?.email || 'demo@example.com',
                        'X-User-Name': currentUser?.name || 'Demo User'
                    }
                });
                const docData = await docResponse.json();
                
                const emailResponse = await fetch(`${API_BASE}/api/emails/${currentClientId}/ingest-sample-emails`, {
                    method: 'POST',
                    headers: {
                        'X-User-Email': currentUser?.email || 'demo@example.com',
                        'X-User-Name': currentUser?.name || 'Demo User'
                    }
                });
                const emailData = await emailResponse.json();
                
                if (docData.success && emailData.success) {
                    showAlert(`Sample data loaded: ${docData.documents?.length || 0} documents, ${emailData.emails_processed || 0} emails`, 'success');
                    
                    await switchClient();
                    
                    const clientName = availableClients.find(c => c.id === currentClientId)?.name || 'this client';
                    addMessage('assistant', `📊 **Sample Data Loaded for ${clientName}!**\n\n✅ ${docData.documents?.length || 0} legal documents processed\n✅ ${emailData.emails_processed || 0} email communications analyzed\n\nYou can now ask questions about the Lexsy advisor equity grant discussion and legal documents!`);
                    
                } else {
                    showAlert('Failed to load some sample data', 'error');
                }
                
            } catch (error) {
                showAlert('Error loading sample data', 'error');
                console.error('Load sample data error:', error);
            }
