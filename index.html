// Auto-resize textarea
            chatInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
            });

            // Close modal when clicking outside
            window.addEventListener('click', function(event) {
                const modal = document.getElementById('addClientModal');
                if (event.target === modal) {
                    hideAddClientModal();
                }
            });
        }

        // ===== CLIENT MANAGEMENT =====

        async function loadClients() {
            try {
                const response = await fetch(`${API_BASE}/api/clients`);
                const data = await response.json();
                
                if (data.success && data.clients) {
                    availableClients = data.clients;
                    
                    const selector = document.getElementById('clientSelector');
                    selector.innerHTML = '<option value="">Select Client...</option>';
                    
                    availableClients.forEach(client => {
                        const option = document.createElement('option');
                        option.value = client.id;
                        option.textContent = `${client.name} (${client.company})`;
                        selector.appendChild(option);
                    });
                    
                    // Auto-select Lexsy if available
                    const lexsyClient = availableClients.find(c => c.name.includes('Lexsy'));
                    if (lexsyClient) {
                        selector.value = lexsyClient.id;
                        switchClient();
                    }
                } else {
                    console.error('Failed to load clients:', data.error);
                }
                
            } catch (error) {
                console.error('Error loading clients:', error);
                showAlert('Failed to load clients', 'error');
            }
        }

        async function switchClient() {
            const selector = document.getElementById('clientSelector');
            const clientId = selector.value;
            
            if (!clientId) {
                currentClientId = null;
                document.getElementById('currentClient').style.display = 'none';
                updateUploadZone();
                updateChatPlaceholder();
                resetTabContents();
                return;
            }
            
            try {
                currentClientId = parseInt(clientId);
                
                // Get client details
                const response = await fetch(`${API_BASE}/api/clients/${clientId}`);
                const data = await response.json();
                
                if (data.success && data.client) {
                    const client = data.client;
                    
                    // Update client display
                    document.getElementById('currentClientName').textContent = client.name;
                    document.getElementById('currentClient').style.display = 'block';
                    
                    // Update stats
                    const stats = client.stats || {};
                    document.getElementById('currentClientStats').textContent = 
                        `${stats.documents || 0} docs • ${stats.emails || 0} emails • ${stats.conversations || 0} chats`;
                    
                    // Update indicators
                    document.getElementById('docsIndicator').style.display = stats.documents > 0 ? 'inline' : 'none';
                    document.getElementById('emailsIndicator').style.display = stats.emails > 0 ? 'inline' : 'none';
                    
                    showAlert(`Switched to ${client.name}`, 'success');
                    
                    // Update UI state
                    updateUploadZone();
                    updateChatPlaceholder();
                    
                    // Load suggested questions
                    loadSuggestedQuestions();
                    
                    // Refresh current tab content
                    const activeTab = document.querySelector('.tab.active');
                    if (activeTab.textContent.includes('Documents')) {
                        loadDocuments();
                    } else if (activeTab.textContent.includes('Email')) {
                        loadEmails();
                    }
                    
                    // Add welcome message
                    addMessage('assistant', `🔄 Switched to client: **${client.name}**. You can now ask questions about their documents and emails, or load sample data to get started.`);
                    
                } else {
                    showAlert('Failed to get client details', 'error');
                }
            } catch (error) {
                showAlert('Failed to switch client', 'error');
                console.error('Switch client error:', error);
            }
        }

        function updateUploadZone() {
            const uploadZone = document.getElementById('uploadZone');
            const uploadNote = document.getElementById('uploadNote');
            
            if (currentClientId) {
                uploadZone.classList.remove('disabled');
                uploadNote.textContent = 'Ready to upload files';
                uploadNote.style.color = '#059669';
            } else {
                uploadZone.classList.add('disabled');
                uploadNote.textContent = 'Select a client first';
                uploadNote.style.color = '#ef4444';
            }
        }

        function updateChatPlaceholder() {
            const chatInput = document.getElementById('chatInput');
            const sendBtn = document.getElementById('sendBtn');
            
            if (currentClientId) {
                const client = availableClients.find(c => c.id === currentClientId);
                chatInput.placeholder = `Ask questions about ${client?.name || 'this client'}'s legal matters...`;
                chatInput.disabled = false;
                sendBtn.disabled = false;
            } else {
                chatInput.placeholder = 'Select a client first, then ask about their legal matters...';
                chatInput.disabled = true;
                sendBtn.disabled = true;
            }
        }

        async function loadSuggestedQuestions() {
            if (!currentClientId) return;
            
            const suggestionsContainer = document.getElementById('suggestedQuestions');
            
            // Client-specific suggestions
            let suggestions = [];
            
            const client = availableClients.find(c => c.id === currentClientId);
            if (client && client.name.includes('Lexsy')) {
                suggestions = [
                    "What equity grant was proposed for John Smith?",
                    "What are the vesting terms discussed in emails?",
                    "How many shares are available in our equity incentive plan?",
                    "What documentation is needed for the advisor agreement?",
                    "What board approvals are required?"
                ];
            } else {
                suggestions = [
                    "Summarize the key legal documents",
                    "What compliance requirements do we have?",
                    "What decisions were made in recent emails?",
                    "What action items are pending?"
                ];
            }
            
            // Create suggestion buttons
            suggestionsContainer.innerHTML = '';
            suggestions.forEach(question => {
                const btn = document.createElement('button');
                btn.className = 'suggestion-btn';
                btn.textContent = question;
                btn.onclick = () => {
                    document.getElementById('chatInput').value = question;
                    sendMessage();
                };
                suggestionsContainer.appendChild(btn);
            });
            
            suggestionsContainer.style.display = suggestions.length > 0 ? 'flex' : 'none';
        }

        function showAddClientModal() {
            document.getElementById('addClientModal').style.display = 'block';
        }

        function hideAddClientModal() {
            document.getElementById('addClientModal').style.display = 'none';
            document.getElementById('addClientForm').reset();
        }

        async function addNewClient(event) {
            event.preventDefault();
            
            const formData = new FormData();
            formData.append('name', document.getElementById('newClientName').value);
            formData.append('email', document.getElementById('newClientEmail').value);
            formData.append('company', document.getElementById('newClientCompany').value);
            formData.append('description', document.getElementById('newClientDescription').value);
            
            try {
                const response = await fetch(`${API_BASE}/api/clients`, {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert(`Client ${data.client.name} added successfully!`, 'success');
                    hideAddClientModal();
                    await loadClients();
                    
                    // Auto-select the new client
                    const selector = document.getElementById('clientSelector');
                    selector.value = data.client.id;
                    await switchClient();
                } else {
                    showAlert(`Failed to add client: ${data.error}`, 'error');
                }
            } catch (error) {
                showAlert('Error adding client', 'error');
                console.error('Add client error:', error);
            }
        }

        async function deleteCurrentClient() {
            if (!currentClientId) return;
            
            const client = availableClients.find(c => c.id === currentClientId);
            if (!client) return;
            
            if (confirm(`Are you sure you want to delete ${client.name}? This will remove all their documents, emails, and conversations.`)) {
                try {
                    const response = await fetch(`${API_BASE}/api/clients/${currentClientId}`, {
                        method: 'DELETE'
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        showAlert(`${client.name} deleted successfully`, 'success');
                        
                        // Reset state
                        currentClientId = null;
                        document.getElementById('currentClient').style.display = 'none';
                        
                        // Reload clients
                        await loadClients();
                        
                        // Reset UI
                        updateUploadZone();
                        updateChatPlaceholder();
                        resetTabContents();
                        
                    } else {
                        showAlert(`Failed to delete client: ${data.error}`, 'error');
                    }
                } catch (error) {
                    showAlert('Error deleting client', 'error');
                    console.error('Delete client error:', error);
                }
            }
        }

        async function loadClientSampleData() {
            if (!currentClientId) return;
            
            try {
                showAlert('Loading sample data for client...', 'info');
                
                // Load sample documents
                const docResponse = await fetch(`${API_BASE}/api/documents/${currentClientId}/upload-sample-documents`, {
                    method: 'POST'
                });
                const docData = await docResponse.json();
                
                // Load sample emails
                const emailResponse = await fetch(`${API_BASE}/api/emails/${currentClientId}/ingest-sample-emails`, {
                    method: 'POST'
                });
                const emailData = await emailResponse.json();
                
                if (docData.success && emailData.success) {
                    showAlert(`Sample data loaded: ${docData.documents?.length || 0} documents, ${emailData.emails_processed || 0} emails`, 'success');
                    
                    // Refresh client stats
                    await switchClient();
                    
                    // Refresh current tab
                    const activeTab = document.querySelector('.tab.active');
                    if (activeTab.textContent.includes('Documents')) {
                        loadDocuments();
                    } else if (activeTab.textContent.includes('Email')) {
                        loadEmails();
                    }
                    
                    // Add context message
                    addMessage('assistant', `📊 Sample data loaded for ${availableClients.find(c => c.id === currentClientId)?.name}! You can now ask questions about the Lexsy advisor equity grant discussion and legal documents.`);
                    
                } else {
                    showAlert('Failed to load some sample data', 'error');
                }
                
            } catch (error) {
                showAlert('Error loading sample data', 'error');
                console.error('Load sample data error:', error);
            }
        }

        // ===== FILE UPLOAD =====

        function handleDragOver(e) {
            e.preventDefault();
            if (currentClientId) {
                e.currentTarget.classList.add('dragover');
            }
        }

        function handleDragLeave(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
        }

        function handleFileDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
            
            if (!isAuthenticated) {
                showAlert('Please sign in first to upload files', 'error');
                return;
            }
            
            if (!currentClientId) {
                showAlert('Please select a client first to upload files', 'error');
                return;
            }
            
            const files = Array.from(e.dataTransfer.files);
            handleFiles(files);
        }

        function handleFileSelect(e) {
            if (!isAuthenticated || !currentClientId) {
                return;
            }
            
            const files = Array.from(e.target.files);
            handleFiles(files);
        }

        function handleFiles(files) {
            const validTypes = ['application/pdf', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document', 'text/plain'];
            const maxSize = 10 * 1024 * 1024; // 10MB

            files.forEach(file => {
                if (!validTypes.includes(file.type)) {
                    showAlert(`Unsupported file type: ${file.name}. Use PDF, DOCX, or TXT.`, 'error');
                    return;
                }

                if (file.size > maxSize) {
                    showAlert(`File too large: ${file.name}. Max size is 10MB.`, 'error');
                    return;
                }

                uploadFile(file);
            });
        }

        async function uploadFile(file) {
            const formData = new FormData();
            formData.append('file', file);

            try {
                showAlert(`Uploading ${file.name}...`, 'info');

                const response = await fetch(`${API_BASE}/api/documents/${currentClientId}/upload`, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-User-Email': currentUser.email,
                        'X-User-Name': currentUser.name
                    }
                });

                const result = await response.json();

                if (result.success) {
                    showAlert(`${file.name} uploaded and analyzed successfully!`, 'success');
                    
                    // Refresh documents tab if active
                    if (document.getElementById('documentsTab').classList.contains('active')) {
                        loadDocuments();
                    }
                    
                    // Refresh client stats
                    await switchClient();

                    // Add success message
                    const clientName = availableClients.find(c => c.id === currentClientId)?.name || 'this client';
                    addMessage('assistant', `📄 I've analyzed "${file.name}" for ${clientName}. You can now ask questions about its contents!`);

                } else {
                    showAlert(`Upload failed: ${result.error}`, 'error');
                }
            } catch (error) {
                showAlert(`Upload error: ${error.message}`, 'error');
                console.error('Upload error:', error);
            }
        }

        // ===== CHAT =====

        async function sendMessage() {
            if (!isAuthenticated || !currentClientId) {
                return;
            }

            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add user message
            addMessage('user', message);
            input.value = '';
            input.style.height = 'auto';
            
            // Hide suggestions after first message
            document.getElementById('suggestedQuestions').style.display = 'none';
            
            // Show typing indicator
            showTypingIndicator();
            
            // Disable send button
            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            
            try {
                const formData = new FormData();
                formData.append('question', message);
                formData.append('include_history', 'true');
                
                const response = await fetch(`${API_BASE}/api/chat/${currentClientId}/ask`, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-User-Email': currentUser.email,
                        'X-User-Name': currentUser.name
                    }
                });
                
                const data = await response.json();
                
                // Remove typing indicator
                hideTypingIndicator();
                
                if (data.success) {
                    addMessage('assistant', data.answer, data.sources);
                } else {
                    addMessage('assistant', '❌ Sorry, I encountered an error analyzing your request. Please try again.');
                }
            } catch (error) {
                hideTypingIndicator();
                addMessage('assistant', '❌ Connection error. Please check your internet connection and try again.');
                console.error('Chat error:', error);
            } finally {
                // Re-enable send button
                sendBtn.disabled = false;
                sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
            }
        }

        function addMessage(sender, content, sources = null) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            let sourcesHtml = '';
            if (sources && sources.length > 0) {
                sourcesHtml = '<div class="message-sources">';
                sourcesHtml += '<strong>Sources:</strong><br>';
                sources.forEach(source => {
                    const icon = source.type === 'document' ? 'fa-file-pdf' : 'fa-envelope';
                    const name = source.filename || source.subject || 'Source';
                    sourcesHtml += `<span class="source-tag"><i class="fas ${icon}"></i> ${name}</span>`;
                });
                sourcesHtml += '</div>';
            }
            
            messageDiv.innerHTML = `
                <div class="message-avatar">${sender === 'user' ? currentUser.name.charAt(0).toUpperCase() : 'AI'}</div>
                <div class="message-content">
                    <div class="message-bubble">${content}</div>
                    ${sourcesHtml}
                </div>
            `;
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function showTypingIndicator() {
            const messagesContainer = document.getElementById('chatMessages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message assistant';
            typingDiv.id = 'typingIndicator';
            
            typingDiv.innerHTML = `
                <div class="message-avatar">AI</div>
                <div class="message-content">
                    <div class="message-bubble">
                        <div class="typing-indicator">
                            <span>Analyzing</span>
                            <div class="typing-dots">
                                <div class="typing-dot"></div>
                                <div class="typing-dot"></div>
                                <div class="typing-dot"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            messagesContainer.appendChild(typingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function hideTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            if (indicator) {
                indicator.remove();
            }
        }

        function resetChat() {
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = `
                <div class="message assistant">
                    <div class="message-avatar">AI</div>
                    <div class="message-content">
                        <div class="message-bubble">
                            👋 Hello! I'm your AI legal assistant. Select a client to get started, then I'll help you analyze their legal documents and email threads.
                            <br><br>
                            Try the <strong>Initialize Demo</strong> button to load sample legal data, or create your own client and upload documents.
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('suggestedQuestions').style.display = 'none';
        }

        // ===== TAB MANAGEMENT =====

        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.add('active');
            event.target.classList.add('active');

            // Load content
            if (tabName === 'documents') {
                loadDocuments();
            } else if (tabName === 'emails') {
                loadEmails();
            }
        }

        function resetTabContents() {
            document.getElementById('documentsContent').innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-file-alt"></i>
                    <h3>No Documents Yet</h3>
                    <p>Select a client and upload PDF, DOCX, or TXT files to start analysis</p>
                </div>
            `;
            
            document.getElementById('emailsContent').innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-envelope"></i>
                    <h3>No Email Threads</h3>
                    <p>Select a client and connect Gmail to analyze email threads</p>
                </div>
            `;
        }

        // ===== DOCUMENTS TAB =====

        async function loadDocuments() {
            const content = document.getElementById('documentsContent');
            
            if (!isAuthenticated) {
                content.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-lock"></i>
                        <h3>Sign In Required</h3>
                        <p>Please sign in to view documents</p>
                    </div>
                `;
                return;
            }
            
            if (!currentClientId) {
                content.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-users"></i>
                        <h3>Select a Client</h3>
                        <p>Please select a client to view their documents</p>
                    </div>
                `;
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/documents/${currentClientId}/documents`);
                const data = await response.json();
                
                if (data.documents && data.documents.length > 0) {
                    content.innerHTML = `
                        <div style="margin-bottom: 1rem;">
                            <h4>Documents for ${data.client_name}</h4>
                            <p style="color: #64748b; font-size: 0.9rem;">Total: ${data.total_documents} documents</p>
                        </div>
                        <div class="content-list">
                            ${data.documents.map(doc => `
                                <div class="content-item">
                                    <div class="content-title">
                                        <i class="fas fa-file-${doc.file_type === 'pdf' ? 'pdf' : doc.file_type === 'docx' ? 'word' : 'alt'}"></i>
                                        ${doc.original_filename || doc.filename}
                                        <span style="margin-left: auto; font-size: 0.8rem; color: ${doc.processing_status === 'completed' ? '#059669' : '#d97706'};">
                                            ${doc.processing_status === 'completed' ? '✅ Ready' : '⏳ Processing'}
                                        </span>
                                    </div>
                                    <div class="content-meta">
                                        ${doc.file_type ? doc.file_type.toUpperCase() : 'DOC'} • ${Math.round((doc.file_size || 0) / 1024)} KB • Uploaded ${new Date(doc.created_at).toLocaleDateString()}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else {
                    const clientName = availableClients.find(c => c.id === currentClientId)?.name || 'this client';
                    content.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-file-alt"></i>
                            <h3>No Documents Yet</h3>
                            <p>Upload PDF, DOCX, or TXT files for ${clientName}</p>
                            <button class="btn btn-primary" onclick="loadClientSampleData()" style="margin-top: 1rem;">
                                <i class="fas fa-database"></i>
                                Load Sample Documents
                            </button>
                        </div>
                    `;
                }
            } catch (error) {
                content.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>Error Loading Documents</h3>
                        <p>Please try again</p>
                    </div>
                `;
                console.error('Load documents error:', error);
            }
        }

        // ===== EMAILS TAB =====

        async function loadEmails() {
            const content = document.getElementById('emailsContent');
            
            if (!isAuthenticated) {
                content.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-lock"></i>
                        <h3>Sign In Required</h3>
                        <p>Please sign in to view email threads</p>
                    </div>
                `;
                return;
            }
            
            if (!currentClientId) {
                content.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-users"></i>
                        <h3>Select a Client</h3>
                        <p>Please select a client to view their email threads</p>
                    </div>
                `;
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/emails/${currentClientId}/emails`);
                const data = await response.json();
                
                if (data.emails && data.emails.length > 0) {
                    // Group emails by thread
                    const threads = {};
                    data.emails.forEach(email => {
                        const threadId = email.thread_id || email.gmail_thread_id || 'default';
                        if (!threads[threadId]) {
                            threads[threadId] = [];
                        }
                        threads[threadId].push(email);
                    });

                    let threadsHtml = `
                        <div style="margin-bottom: 1rem;">
                            <h4>Email Threads for ${data.client_name}</h4>
                            <p style="color: #64748b; font-size: 0.9rem;">Total: ${data.total_emails} emails in ${Object.keys(threads).length} threads</p>
                        </div>
                    `;
                    
                    Object.entries(threads).forEach(([threadId, emails]) => {
                        const firstEmail = emails[0];
                        const lastEmail = emails[emails.length - 1];
                        
                        threadsHtml += `
                            <div class="content-item">
                                <div class="content-title">
                                    <i class="fas fa-envelope"></i>
                                    ${firstEmail.subject || 'No Subject'}
                                    <span style="margin-left: auto; font-size: 0.8rem; color: #64748b;">
                                        ${emails.length} message${emails.length !== 1 ? 's' : ''}
                                    </span>
                                </div>
                                <div class="content-meta" style="margin-bottom: 0.5rem;">
                                    <strong>Participants:</strong> ${[...new Set(emails.flatMap(e => [e.sender, e.recipient]).filter(Boolean))].join(', ')}
                                </div>
                                <div style="max-height: 200px; overflow-y: auto; background: #f8fafc; border-radius: 4px; padding: 0.5rem;">
                                    ${emails.slice(0, 3).map(email => `
                                        <div style="border-bottom: 1px solid #e2e8f0; padding: 0.5rem 0; margin-bottom: 0.5rem;">
                                            <div style="font-weight: 600; font-size: 0.8rem; color: #374151;">
                                                ${email.sender || 'Unknown'} 
                                                <span style="font-weight: normal; color: #64748b;">
                                                    • ${email.date_sent ? new Date(email.date_sent).toLocaleDateString() : 'Unknown date'}
                                                </span>
                                            </div>
                                            <div style="font-size: 0.85rem; color: #374151; line-height: 1.4; margin-top: 0.25rem;">
                                                ${(email.snippet || email.body || 'No content available').substring(0, 150)}${(email.snippet || email.body || '').length > 150 ? '...' : ''}
                                            </div>
                                        </div>
                                    `).join('')}
                                    ${emails.length > 3 ? `<div style="text-align: center; color: #64748b; font-size: 0.8rem;">... and ${emails.length - 3} more messages</div>` : ''}
                                </div>
                            </div>
                        `;
                    });

                    content.innerHTML = `<div class="content-list">${threadsHtml}</div>`;
                } else {
                    const clientName = availableClients.find(c => c.id === currentClientId)?.name || 'this client';
                    content.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-envelope"></i>
                            <h3>No Email Threads</h3>
                            <p>Connect Gmail to start analyzing email threads for ${clientName}</p>
                            <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 1rem;">
                                <button class="btn btn-gmail" onclick="connectGmail()">
                                    <i class="fab fa-google"></i>
                                    Connect Gmail
                                </button>
                                <button class="btn btn-secondary" onclick="loadClientSampleData()">
                                    <i class="fas fa-database"></i>
                                    Load Sample Emails
                                </button>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                content.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>Error Loading Emails</h3>
                        <p>Please try again or check your Gmail connection</p>
                    </div>
                `;
                console.error('Load emails error:', error);
            }
        }

        // ===== GMAIL INTEGRATION =====

        async function connectGmail() {
            if (!isAuthenticated) {
                showAlert('Please sign in first to connect Gmail', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/auth/gmail/auth-url`);
                const data = await response.json();
                
                if (data.success) {
                    if (data.demo_mode || data.auth_url === "#demo") {
                        // Demo mode - simulate connection
                        document.getElementById('gmailStatus').style.display = 'block';
                        document.getElementById('gmailBtn').innerHTML = '<i class="fas fa-check"></i> Gmail Connected (Demo)';
                        document.getElementById('monitoringPanel').style.display = 'block';
                        showAlert('Gmail connected successfully (demo mode)!', 'success');
                        
                        // Add demo message
                        addMessage('assistant', '📧 Gmail connected in demo mode! You can now monitor email threads and load sample email conversations for analysis.');
                    } else {
                        showAlert('Opening Gmail authentication...', 'info');
                        
                        const authWindow = window.open(
                            data.auth_url, 
                            'gmail_auth', 
                            'width=500,height=600,scrollbars=yes,resizable=yes'
                        );
                        
                        // Listen for success message from popup
                        const messageHandler = function(event) {
                            if (event.data.type === 'GMAIL_AUTH_SUCCESS') {
                                document.getElementById('gmailStatus').style.display = 'block';
                                document.getElementById('gmailBtn').innerHTML = '<i class="fas fa-check"></i> Gmail Connected';
                                document.getElementById('monitoringPanel').style.display = 'block';
                                showAlert('Gmail connected successfully!', 'success');
                                
                                // Remove event listener
                                window.removeEventListener('message', messageHandler);
                                
                                if (document.getElementById('emailsTab').classList.contains('active')) {
                                    loadEmails();
                                }
                            }
                        };
                        
                        window.addEventListener('message', messageHandler);
                    }
                } else {
                    showAlert('Failed to get Gmail auth URL. Using demo mode.', 'error');
                }
            } catch (error) {
                showAlert('Gmail connection error. Please try again.', 'error');
                console.error('Gmail connection error:', error);
            }
        }

        async function startThreadMonitoring() {
            if (!isAuthenticated || !currentClientId) {
                showAlert('Please sign in and select a client first', 'error');
                return;
            }

            const threadSelector = document.getElementById('threadSelector');
            const selectedThread = threadSelector.value;
            const threadText = threadSelector.options[threadSelector.selectedIndex].text;

            try {
                showAlert(`Starting monitoring for ${threadText}...`, 'info');
                
                const formData = new FormData();
                formData.append('thread_id', selectedThread);
                formData.append('check_interval', '300'); // 5 minutes
                
                const response = await fetch(`${API_BASE}/api/emails/${currentClientId}/start-thread-monitoring`, {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Update monitoring status
                    document.getElementById('monitoringStatus').style.display = 'block';
                    document.getElementById('monitoringStatusText').textContent = 'Active';
                    document.getElementById('startMonitorBtn').innerHTML = '<i class="fas fa-stop"></i> Stop Monitoring';
                    document.getElementById('startMonitorBtn').onclick = stopThreadMonitoring;
                    
                    monitoringActive = true;
                    updateMonitoringDisplay();
                    
                    showAlert(`✅ Now monitoring ${threadText}! Checking every 5 minutes.`, 'success');
                    
                    // Add helpful message to chat
                    addMessage('assistant', `📡 Gmail monitoring started for "${threadText}". I'll automatically detect and process new messages in this thread.`);
                    
                    // Start periodic status updates
                    startMonitoringUpdates();
                } else {
                    showAlert('Failed to start monitoring. Please try again.', 'error');
                }
            } catch (error) {
                showAlert('Error starting monitoring. Please try again.', 'error');
                console.error('Start monitoring error:', error);
            }
        }

        async function stopThreadMonitoring() {
            try {
                const threadSelector = document.getElementById('threadSelector');
                const selectedThread = threadSelector.value;
                
                const formData = new FormData();
                formData.append('thread_id', selectedThread);
                
                const response = await fetch(`${API_BASE}/api/emails/stop-thread-monitoring`, {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('monitoringStatusText').textContent = 'Inactive';
                    document.getElementById('startMonitorBtn').innerHTML = '<i class="fas fa-play"></i> Start Monitoring';
                    document.getElementById('startMonitorBtn').onclick = startThreadMonitoring;
                    
                    monitoringActive = false;
                    if (monitoringInterval) {
                        clearInterval(monitoringInterval);
                    }
                    
                    showAlert('Monitoring stopped', 'success');
                }
            } catch (error) {
                showAlert('Error stopping monitoring', 'error');
                console.error('Stop monitoring error:', error);
            }
        }

        function startMonitoringUpdates() {
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
            }
            
            monitoringInterval = setInterval(updateMonitoringDisplay, 30000); // Update every 30 seconds
        }

        async function updateMonitoringDisplay() {
            if (!monitoringActive) return;
            
            try {
                const response = await fetch(`${API_BASE}/api/emails/monitoring-status`);
                const data = await response.json();
                
                if (data.active_monitors && data.active_monitors.length > 0) {
                    const monitor = data.active_monitors[0];
                    document.getElementById('lastCheckTime').textContent = 
                        new Date(monitor.last_check).toLocaleTimeString();
                    document.getElementById('messagesFound').textContent = monitor.messages_found;
                }
            } catch (error) {
                console.error('Error updating monitoring display:', error);
            }
        }

        function resetGmailStatus() {
            document.getElementById('gmailStatus').style.display = 'none';
            document.getElementById('gmailBtn').innerHTML = '<i class="fab fa-google"></i> Connect Gmail';
            document.getElementById('monitoringPanel').style.display = 'none';
            
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
                monitoringActive = false;
            }
        }

        // ===== DEMO AND UTILITIES =====

        async function initializeFullDemo() {
            try {
                showAlert('Initializing full demo with sample legal data...', 'info');
                
                const response = await fetch(`${API_BASE}/api/demo/initialize-full`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert('✅ Full demo initialized! Sample clients and data are ready.', 'success');
                    
                    // Reload clients
                    await loadClients(); 
                    
                    // Simulate Gmail connection
                    document.getElementById('gmailStatus').style.display = 'block';
                    document.getElementById('gmailBtn').innerHTML = '<i class="fas fa-check"></i> Gmail Connected (Demo)';
                    document.getElementById('monitoringPanel').style.display = 'block';
                    
                    // Add welcome message
                    addMessage('assistant', `🎉 **Demo Environment Ready!**

I've set up sample legal data including:
• **Lexsy, Inc.** with advisor equity grant discussion (6 emails)
• **TechCorp LLC** for comparison (empty - you can add data)
• Legal documents: Board approvals, advisor agreements, equity plans
• Gmail monitoring capabilities

**Try asking questions like:**
• "What equity grant was proposed for John Smith?"
• "What are the vesting terms discussed in emails?"
• "How many shares are available in our equity incentive plan?"
• "What documentation is needed for the advisor agreement?"

Select **Lexsy, Inc.** from the client dropdown to get started!`);
                    
                } else {
                    showAlert('Demo initialization failed. Please try again.', 'error');
                }

            } catch (error) {
                showAlert('Demo initialization failed. Please try again.', 'error');
                console.error('Demo initialization error:', error);
            }
        }

        function clearAllData() {
            if (confirm('Are you sure you want to clear all client data? This action cannot be undone.')) {
                // Clear local storage (except user auth)
                const userKey = localStorage.getItem('aiAssistantUser');
                localStorage.clear();
                if (userKey) {
                    localStorage.setItem('aiAssistantUser', userKey);
                }

                // Reset application state
                currentClientId = null;
                availableClients = [];
                
                // Stop monitoring
                if (monitoringInterval) {
                    clearInterval(monitoringInterval);
                    monitoringActive = false;
                }

                // Reset UI
                resetAppState();
                showAlert('All data cleared successfully', 'success');
                
                // Add reset message
                addMessage('assistant', '🔄 All client data has been cleared. You can now create new clients or initialize the demo again.');
            }
        }

        function showAlert(message, type = 'info') {
            // Remove existing alerts
            const existingAlerts = document.querySelectorAll('.alert');
            existingAlerts.forEach(alert => alert.remove());

            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            
            const icon = type === 'success' ? 'fa-check-circle' : 
                        type === 'error' ? 'fa-exclamation-circle' : 
                        'fa-info-circle';
            
            alertDiv.innerHTML = `
                <i class="fas ${icon}"></i>
                <span>${message}</span>
            `;

            const container = document.querySelector('.container') || document.body;
            container.insertBefore(alertDiv, container.firstChild);

            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('AI Legal Assistant initialized');
        });
    </script>
</body>
</html><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Legal Assistant - Document & Email Analysis</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #f8fafc;
            color: #1e293b;
            line-height: 1.6;
        }

        .header {
            background: linear-gradient(135deg, #1e293b, #475569);
            color: white;
            padding: 1rem 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.5rem;
            font-weight: 600;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #3b82f6;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .auth-section {
            background: white;
            border-radius: 8px;
            padding: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            margin: 2rem auto;
        }

        .auth-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-label {
            font-weight: 500;
            color: #374151;
        }

        .form-input {
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 1rem;
        }

        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 2rem;
        }

        .sidebar {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            height: fit-content;
            position: sticky;
            top: 2rem;
        }

        .section {
            margin-bottom: 2rem;
        }

        .section h3 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #374151;
        }

        .btn {
            width: 100%;
            padding: 0.75rem;
            border: none;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #2563eb;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: #f1f5f9;
            color: #475569;
            border: 1px solid #e2e8f0;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #e2e8f0;
        }

        .btn-danger {
            background: #dc2626;
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background: #b91c1c;
        }

        .btn-gmail {
            background: #4285f4;
            color: white;
        }

        .btn-gmail:hover:not(:disabled) {
            background: #3367d6;
        }

        .upload-zone {
            border: 2px dashed #cbd5e1;
            border-radius: 6px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #f8fafc;
            margin-bottom: 1rem;
        }

        .upload-zone:hover, .upload-zone.dragover {
            border-color: #3b82f6;
            background: #eff6ff;
            transform: translateY(-2px);
        }

        .upload-zone.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        .upload-icon {
            font-size: 2.5rem;
            color: #3b82f6;
            margin-bottom: 1rem;
        }

        .main-content {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .tab-nav {
            display: flex;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
        }

        .tab {
            flex: 1;
            padding: 1rem;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 500;
            color: #64748b;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .tab.active {
            background: white;
            color: #1e293b;
            border-bottom: 3px solid #3b82f6;
        }

        .tab-content {
            padding: 2rem;
            display: none;
            min-height: 500px;
        }

        .tab-content.active {
            display: block;
        }

        .chat-container {
            height: 500px;
            display: flex;
            flex-direction: column;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            background: #f8fafc;
            border-radius: 6px;
            margin-bottom: 1rem;
            border: 1px solid #e2e8f0;
        }

        .message {
            margin-bottom: 1.5rem;
            display: flex;
            gap: 0.75rem;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
            flex-shrink: 0;
        }

        .user .message-avatar {
            background: #3b82f6;
            color: white;
        }

        .assistant .message-avatar {
            background: #1e293b;
            color: white;
        }

        .message-content {
            flex: 1;
            max-width: 80%;
        }

        .message-bubble {
            padding: 1rem 1.25rem;
            border-radius: 12px;
            word-wrap: break-word;
            line-height: 1.5;
        }

        .user .message-bubble {
            background: #3b82f6;
            color: white;
            border-bottom-right-radius: 4px;
        }

        .assistant .message-bubble {
            background: white;
            border: 1px solid #e2e8f0;
            border-bottom-left-radius: 4px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        .message-sources {
            margin-top: 0.75rem;
            font-size: 0.8rem;
        }

        .source-tag {
            display: inline-block;
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            margin-right: 0.5rem;
            margin-bottom: 0.25rem;
            color: #64748b;
        }

        .chat-input-container {
            display: flex;
            gap: 0.75rem;
            align-items: flex-end;
        }

        .chat-input {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 0.9rem;
            resize: none;
            min-height: 44px;
            max-height: 120px;
            font-family: inherit;
        }

        .chat-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .send-btn {
            padding: 0.75rem 1rem;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .send-btn:hover:not(:disabled) {
            background: #2563eb;
        }

        .send-btn:disabled {
            background: #94a3b8;
            cursor: not-allowed;
        }

        .empty-state {
            text-align: center;
            padding: 3rem 2rem;
        }

        .empty-state i {
            font-size: 3rem;
            color: #cbd5e1;
            margin-bottom: 1rem;
        }

        .empty-state h3 {
            margin-bottom: 0.5rem;
            color: #475569;
        }

        .empty-state p {
            color: #64748b;
            margin-bottom: 1.5rem;
        }

        .content-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            max-height: 400px;
            overflow-y: auto;
        }

        .content-item {
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 1rem;
            transition: all 0.2s;
            background: white;
        }

        .content-item:hover {
            border-color: #3b82f6;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .content-title {
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 0.25rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .content-meta {
            font-size: 0.875rem;
            color: #64748b;
        }

        .alert {
            padding: 0.75rem 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .alert-success {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #bbf7d0;
        }

        .alert-error {
            background: #fef2f2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        .alert-info {
            background: #eff6ff;
            color: #1e40af;
            border: 1px solid #bfdbfe;
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #64748b;
            font-style: italic;
        }

        .typing-dots {
            display: flex;
            gap: 0.25rem;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #64748b;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 2rem;
            border-radius: 8px;
            width: 90%;
            max-width: 400px;
        }

        .client-selector {
            position: relative;
        }

        .current-client {
            background: #f0f9ff;
            border: 1px solid #0ea5e9;
            border-radius: 6px;
            padding: 0.75rem;
            margin-top: 0.5rem;
            font-size: 0.875rem;
        }

        .client-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .client-actions .btn {
            margin-bottom: 0;
            font-size: 0.8rem;
            padding: 0.5rem;
        }

        .monitoring-panel {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .monitoring-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #1e293b;
        }

        .monitoring-status {
            font-size: 0.875rem;
            color: #64748b;
        }

        .thread-selector {
            margin-top: 1rem;
            margin-bottom: 1rem;
        }

        .suggestion-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .suggestion-btn {
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
            color: #374151;
            padding: 0.5rem 0.75rem;
            border-radius: 4px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .suggestion-btn:hover {
            background: #e2e8f0;
            border-color: #3b82f6;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .stat-card {
            background: #f8fafc;
            padding: 1rem;
            border-radius: 6px;
            text-align: center;
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1e293b;
        }

        .stat-label {
            font-size: 0.8rem;
            color: #64748b;
        }

        @media (max-width: 768px) {
            .main-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .sidebar {
                position: static;
            }

            .container {
                padding: 1rem;
            }

            .chat-container {
                height: 400px;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <i class="fas fa-scale-balanced"></i>
                <span>AI Legal Assistant</span>
            </div>
            <div class="user-info" id="userInfo" style="display: none;">
                <span id="userNameDisplay">User</span>
                <div class="user-avatar" id="userAvatar">U</div>
                <button onclick="logout()" style="background: none; border: 1px solid rgba(255,255,255,0.3); color: white; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">
                    Logout
                </button>
            </div>
        </div>
    </header>

    <!-- Authentication Section -->
    <div id="authSection" class="auth-section">
        <div class="auth-header">
            <h2>Welcome to AI Legal Assistant</h2>
            <p style="color: #6b7280; margin-top: 0.5rem;">Sign in to analyze documents and emails</p>
        </div>
        <form class="auth-form" onsubmit="handleAuth(event)">
            <div class="form-group">
                <label class="form-label">Name</label>
                <input type="text" class="form-input" id="userName" placeholder="Your name" required>
            </div>
            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" class="form-input" id="userEmail" placeholder="your@email.com" required>
            </div>
            <div class="form-group">
                <label class="form-label">Organization</label>
                <input type="text" class="form-input" id="userOrg" placeholder="Law firm or company" required>
            </div>
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-sign-in-alt"></i>
                Start Analysis
            </button>
        </form>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="container" style="display: none;">
        <div class="main-grid">
            <!-- Sidebar -->
            <aside class="sidebar">
                <!-- Client Management -->
                <div class="section">
                    <h3><i class="fas fa-users"></i> Client Management</h3>
                    
                    <div class="client-selector">
                        <select id="clientSelector" class="form-input" onchange="switchClient()">
                            <option value="">Select Client...</option>
                        </select>
                        
                        <div id="currentClient" class="current-client" style="display: none;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong id="currentClientName">Client Name</strong>
                                    <div style="font-size: 0.75rem; color: #64748b;" id="currentClientStats">
                                        Loading stats...
                                    </div>
                                </div>
                                <div style="display: flex; gap: 0.25rem;">
                                    <span id="docsIndicator" title="Has Documents" style="display: none;">📄</span>
                                    <span id="emailsIndicator" title="Has Emails" style="display: none;">📧</span>
                                </div>
                            </div>
                            
                            <div class="client-actions">
                                <button class="btn btn-secondary" onclick="loadClientSampleData()" id="loadSampleBtn">
                                    <i class="fas fa-database"></i>
                                    Load Sample Data
                                </button>
                                <button class="btn btn-danger" onclick="deleteCurrentClient()" id="deleteClientBtn">
                                    <i class="fas fa-trash"></i>
                                    Delete
                                </button>
                            </div>
                        </div>
                        
                        <button class="btn btn-secondary" onclick="showAddClientModal()" style="margin-top: 0.5rem;">
                            <i class="fas fa-plus"></i>
                            Add New Client
                        </button>
                    </div>
                </div>

                <!-- Document Upload -->
                <div class="section">
                    <h3><i class="fas fa-upload"></i> Upload Documents</h3>
                    <div class="upload-zone" id="uploadZone">
                        <div class="upload-icon">
                            <i class="fas fa-cloud-upload-alt"></i>
                        </div>
                        <div style="font-weight: 500; margin-bottom: 0.25rem;">Drop files here</div>
                        <div style="font-size: 0.875rem; color: #64748b;">PDF, DOCX, TXT • Max 10MB</div>
                        <div style="font-size: 0.75rem; color: #ef4444; margin-top: 0.5rem;" id="uploadNote">
                            Select a client first
                        </div>
                        <input type="file" id="fileInput" multiple accept=".pdf,.docx,.doc,.txt" style="display: none;">
                    </div>
                </div>

                <!-- Gmail Integration -->
                <div class="section">
                    <h3><i class="fab fa-google"></i> Gmail Integration</h3>
                    <button class="btn btn-gmail" onclick="connectGmail()" id="gmailBtn">
                        <i class="fab fa-google"></i>
                        Connect Gmail
                    </button>
                    <div id="gmailStatus" style="display: none; margin-top: 0.5rem; font-size: 0.875rem; color: #059669;">
                        <i class="fas fa-check-circle"></i> Gmail connected (Demo)
                    </div>

                    <!-- Thread Monitoring Panel -->
                    <div id="monitoringPanel" class="monitoring-panel" style="display: none;">
                        <div class="monitoring-header">
                            <i class="fas fa-radar"></i>
                            Thread Monitoring
                        </div>
                        
                        <div class="thread-selector">
                            <label class="form-label">Monitor Thread:</label>
                            <select id="threadSelector" class="form-input">
                                <option value="mock_thread_equity_001">Advisor Equity Grant (6 messages)</option>
                                <option value="mock_thread_contract_002">Enterprise Contract (2 messages)</option>
                            </select>
                        </div>

                        <button class="btn btn-secondary" onclick="startThreadMonitoring()" id="startMonitorBtn">
                            <i class="fas fa-play"></i>
                            Start Monitoring
                        </button>
                        
                        <div id="monitoringStatus" class="monitoring-status" style="display: none;">
                            <strong>Status:</strong> <span id="monitoringStatusText">Inactive</span><br>
                            <strong>Last Check:</strong> <span id="lastCheckTime">Never</span><br>
                            <strong>Messages Found:</strong> <span id="messagesFound">0</span>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="section">
                    <h3><i class="fas fa-rocket"></i> Quick Actions</h3>
                    <button class="btn btn-primary" onclick="initializeFullDemo()" id="demoSetupBtn">
                        <i class="fas fa-magic"></i>
                        Initialize Demo
                    </button>
                    <button class="btn btn-secondary" onclick="clearAllData()">
                        <i class="fas fa-trash-alt"></i>
                        Clear All Data
                    </button>
                </div>
            </aside>

            <!-- Main Content -->
            <main class="main-content">
                <nav class="tab-nav">
                    <button class="tab active" onclick="switchTab('chat')">
                        <i class="fas fa-comments"></i> Chat Analysis
                    </button>
                    <button class="tab" onclick="switchTab('documents')">
                        <i class="fas fa-file-alt"></i> Documents
                    </button>
                    <button class="tab" onclick="switchTab('emails')">
                        <i class="fas fa-envelope"></i> Email Threads
                    </button>
                </nav>

                <!-- Chat Tab -->
                <div id="chatTab" class="tab-content active">
                    <div class="chat-container">
                        <div class="chat-messages" id="chatMessages">
                            <div class="message assistant">
                                <div class="message-avatar">AI</div>
                                <div class="message-content">
                                    <div class="message-bubble">
                                        👋 Hello! I'm your AI legal assistant. Select a client to get started, then I'll help you analyze their legal documents and email threads. 
                                        <br><br>
                                        Try the <strong>Initialize Demo</strong> button to load sample legal data, or create your own client and upload documents.
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Suggested Questions -->
                        <div id="suggestedQuestions" class="suggestion-buttons" style="display: none;">
                            <!-- Questions will be populated dynamically -->
                        </div>

                        <div class="chat-input-container">
                            <textarea id="chatInput" class="chat-input" placeholder="Select a client first, then ask about their legal matters..." rows="1" disabled></textarea>
                            <button class="send-btn" onclick="sendMessage()" id="sendBtn" disabled>
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Documents Tab -->
                <div id="documentsTab" class="tab-content">
                    <div id="documentsContent" class="empty-state">
                        <i class="fas fa-file-alt"></i>
                        <h3>No Documents Yet</h3>
                        <p>Select a client and upload PDF, DOCX, or TXT files to start analysis</p>
                    </div>
                </div>

                <!-- Email Threads Tab -->
                <div id="emailsTab" class="tab-content">
                    <div id="emailsContent" class="empty-state">
                        <i class="fas fa-envelope"></i>
                        <h3>No Email Threads</h3>
                        <p>Select a client and connect Gmail to analyze email threads</p>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Add Client Modal -->
    <div id="addClientModal" class="modal">
        <div class="modal-content">
            <h3 style="margin-bottom: 1rem;">Add New Client</h3>
            <form id="addClientForm" onsubmit="addNewClient(event)">
                <div class="form-group">
                    <label class="form-label">Client Name</label>
                    <input type="text" class="form-input" id="newClientName" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-input" id="newClientEmail" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Company</label>
                    <input type="text" class="form-input" id="newClientCompany" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea class="form-input" id="newClientDescription" rows="3"></textarea>
                </div>
                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Add Client</button>
                    <button type="button" class="btn btn-secondary" onclick="hideAddClientModal()" style="flex: 1;">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Global state
        let currentUser = null;
        let isAuthenticated = false;
        let currentClientId = null;
        let availableClients = [];
        let monitoringActive = false;
        let monitoringInterval = null;
        const API_BASE = window.location.origin;

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            setupEventListeners();
        });

        function checkAuth() {
            const stored = localStorage.getItem('aiAssistantUser');
            if (stored) {
                currentUser = JSON.parse(stored);
                showMainApp();
            }
        }

        function handleAuth(event) {
            event.preventDefault();
            
            const name = document.getElementById('userName').value;
            const email = document.getElementById('userEmail').value;
            const org = document.getElementById('userOrg').value;
            
            currentUser = { name, email, org };
            localStorage.setItem('aiAssistantUser', JSON.stringify(currentUser));
            
            showMainApp();
        }

        function showMainApp() {
            document.getElementById('authSection').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            
            // Update header
            const userInfo = document.getElementById('userInfo');
            const userNameDisplay = document.getElementById('userNameDisplay');
            const userAvatar = document.getElementById('userAvatar');
            
            if (currentUser && currentUser.name && userNameDisplay && userAvatar) {
                userInfo.style.display = 'flex';
                userNameDisplay.textContent = currentUser.name;
                userAvatar.textContent = currentUser.name.charAt(0).toUpperCase();
            }
            
            isAuthenticated = true;
            loadClients();
            
            showAlert(`Welcome ${currentUser?.name || 'User'}! Ready to analyze legal documents.`, 'success');
        }

        function logout() {
            localStorage.removeItem('aiAssistantUser');
            currentUser = null;
            isAuthenticated = false;
            currentClientId = null;
            availableClients = [];
            
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
                monitoringActive = false;
            }
            
            document.getElementById('authSection').style.display = 'block';
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('userInfo').style.display = 'none';
            
            document.querySelector('.auth-form').reset();
            resetAppState();
        }

        function resetAppState() {
            // Reset client selector
            const selector = document.getElementById('clientSelector');
            selector.innerHTML = '<option value="">Select Client...</option>';
            document.getElementById('currentClient').style.display = 'none';
            
            // Reset upload zone
            updateUploadZone();
            
            // Reset tab contents
            resetTabContents();
            
            // Reset chat
            resetChat();
            
            // Reset Gmail status
            resetGmailStatus();
        }

        function setupEventListeners() {
            // File upload
            const uploadZone = document.getElementById('uploadZone');
            const fileInput = document.getElementById('fileInput');

            uploadZone.addEventListener('click', () => {
                if (currentClientId) {
                    fileInput.click();
                }
            });
            uploadZone.addEventListener('dragover', handleDragOver);
            uploadZone.addEventListener('dragleave', handleDragLeave);
            uploadZone.addEventListener('drop', handleFileDrop);
            fileInput.addEventListener('change', handleFileSelect);

            // Chat input
            const chatInput = document.getElementById('chatInput');
            chatInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // Auto-resize textarea
            chatInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this
